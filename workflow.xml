<?xml version="1.0" encoding="UTF-8"?>
<workflow-app xmlns="uri:oozie:workflow:0.4"
    name="Load hive incrementally">
       <credentials>
                <credential name='hive_credentials' type='hcat'>
                        <property>
                            <name>hcat.metastore.uri</name>
                            <value>${P_METASTORE}</value>
                        </property>
                        <property>
                            <name>hcat.metastore.principal</name>
                            <value>${P_METASTORE_KERBEROS}</value>
                        </property>
                </credential>

 <credential name="hive2_credentials" type="hive2">
      <property>
        <name>hive2.server.principal</name>
          <value>${P_HIVE_KERBEROS}</value>
      </property>
     <property>
       <name>hive2.jdbc.url</name>
         <value>${P_URL}</value>
      </property>
    </credential>
</credentials>

    <start to="shellAction" />
    <action name="shellAction">
        <shell xmlns="uri:oozie:shell-action:0.1">
            <job-tracker>${jobtracker}</job-tracker>
            <name-node>${namenode}</name-node>
            <prepare>
              <delete path="/tmp/${wf:user()}"/>
            </prepare>
            <exec>${prescript}</exec> 
            <env-var>ID=${P_ID}</env-var> 
            <env-var>URL=${P_URL}</env-var> 
            <env-var>DATABASE=${P_DATABASE}</env-var> 
            <env-var>TABLE=${P_TABLE}</env-var> 
            <env-var>HIVE_CREATESCRIPT=${HIVE_CREATESCRIPT}</env-var> 
            <env-var>HIVE_UPDATESCRIPT=${HIVE_UPDATESCRIPT}</env-var> 
            <env-var>STAGETABLE=${S_STAGETABLE}</env-var>
            <env-var>HIVE2_KERBEROS=${P_HIVE_KERBEROS}</env-var>
            <env-var>KERB_PRINC=${K_PRINC}</env-var>
            <env-var>KERB_PASSWORD=${K_PASSWORD}</env-var>
            <env-var>HADOOP_USER_NAME=${wf:user()}</env-var>
            
            <file>${prescriptPath}</file>          
            <capture-output />
        </shell>
        <ok to="forking" />
        <error to="fail" />
    </action>

    <fork name="forking">
        <path start="echoAction"/>
        <path start="sqoopAction"/>
    </fork>

    <join name="join-action" to="end" />

    <action name="echoAction">
        <shell xmlns="uri:oozie:shell-action:0.1">
            <job-tracker>${jobtracker}</job-tracker>
            <name-node>${namenode}</name-node>
            <exec>${echoscript}</exec>
            <env-var>LASTID=${wf:actionData('shellAction')['LASTID']}</env-var>
            <file>${echoscriptPath}</file>
            <capture-output />
        </shell>
        <ok to="join-action" />
        <error to="fail" />
    </action>


    <action name="sqoopAction" cred="hive_credentials">
        <sqoop xmlns="uri:oozie:sqoop-action:0.2">
            <job-tracker>${jobtracker}</job-tracker>
            <name-node>${namenode}</name-node>
  
<arg>import</arg>
<arg>--connect</arg>
<arg>${S_URL}</arg>
<arg>--username=${S_USER}</arg>
<arg>--password=${S_PASSWORD}</arg>
<arg>--table=${P_TABLE}</arg>
<arg>--hive-import</arg>
<arg>--hive-overwrite</arg>
<arg>--create-hive-table</arg>
<arg>--hive-table</arg>
<arg>customers</arg>
<arg>--hive-database</arg>
<arg>stagedb</arg>
<arg>--driver</arg>
<arg>${S_DRIVER}</arg>
<arg>--where</arg>
<arg>${P_ID} > ${wf:actionData('shellAction')['LASTID']}</arg>
<arg>--target-dir</arg>
<arg>/tmp/${wf:user()}</arg>

        </sqoop>
        <ok to="check-table" />
        <error to="fail" />
    </action>

    <decision name="check-table">
        <switch>
            <case to="create">
                ${ wf:actionData('shellAction')['EXIST'] eq '0'}
            </case>
            <case to="update">
                ${ wf:actionData('shellAction')['EXIST'] eq '1'}
	    </case>
            <default to="join-action"/>
        </switch>
    </decision>

   <action name="create" cred="hive2_credentials">

        <hive2 xmlns="uri:oozie:hive2-action:0.1" >
            <job-tracker>${jobtracker}</job-tracker>
            <name-node>${namenode}</name-node>
            <jdbc-url>${P_URL}</jdbc-url> 
            <script>${HIVE_CREATESCRIPT}</script>
        </hive2>
        <ok to="join-action"/>
        <error to="fail"/>

   </action>

   <action name="update" cred="hive2_credentials">

        <hive2 xmlns="uri:oozie:hive2-action:0.1">
            <job-tracker>${jobtracker}</job-tracker>
            <name-node>${namenode}</name-node>
            <jdbc-url>${P_URL}</jdbc-url>
            <script>${HIVE_UPDATESCRIPT}</script>
        </hive2>
        <ok to="join-action"/>
        <error to="fail"/>

   </action>


    <kill name="fail">
        <message>Job failed, error
            message[${wf:errorMessage(wf:lastErrorNode())}]</message>
    </kill>
    <end name="end" />
</workflow-app>
